#!/bin/bash

set -e

DOTFILES=~/dotfiles

err() {
  echo "$1"
  exit 1
}

get_dotfiles() {
  echo "Installing $DOTFILES"

  if [ ! -d $DOTFILES ]; then
    echo "Cloning dotfiles repo"

    url="https://"
    if [[ -n "${TOKEN}" ]]; then
      url=""$url""${TOKEN}"@"
    fi
    repo=""$url"github.com/apeduru/dotfiles.git"

    git clone "$repo" "$DOTFILES"
  else
    err "$DOTFILES already exists"
  fi

  cd $DOTFILES
}

case "$(uname -s)" in 
  Darwin)
    get_dotfiles
    if  [ ! -e $(which brew) ]; then
      /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi
    brew update
    brew bundle

    make up
    ;;
  Linux)
    if [ ! -e $(which apt) ]; then
      err "Unsupported Linux"
    fi
    get_dotfiles
    sudo apt update
    cat $DOTFILES/packages.list | xargs sudo apt-get --yes install

    make up
    ;;
  *)
    err "Unrecognized OS"
    ;;
esac

exit 0
